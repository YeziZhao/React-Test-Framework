# 1 github secret text 生成
sercret text： 此处需要一个对项目有写权限的账户

进入github --> setting --> Developer settings => Personal Access Token --> Generate new token <br>

![](assets/38.png)<br>

点击add会生成一个tokens.自己先保存此token，如果丢失，之后再也无法找到这个token。需要重新再创建。

![](assets/39.png)<br>

# 2 jenkins 生成webhook
在jenkins的配置中，找到gitHub Servers, 点击高级按钮：<br>
![](assets/40.png)<br>
按照下面的操作选择,最后生成hook 的url。<br>
![](assets/41.png)<br>
![](assets/51.png)<br>
# 3 GitHub webhooks 设置
进入GitHub上指定的项目 --> setting --> WebHooks&Services --> add webhook --> 输入刚刚部署jenkins的服务器的IP
![](assets/42.png)<br>

# 4 创建一个freestyle任务
- General 设置 填写GitHub project URL, 也就是你的项目主页 eg. https://github.com/your_name/your_repo_name<br>
![](assets/43.png)<br>
- 配置源码管理<br>
![](assets/44.png)<br>
- 填写项目的git地址, eg. https://github.com/your_name/your_repo_name.git
- 添加github用户和密码
- 选择githubweb源码库浏览器，并填上你的项目URL，这样每次构建都会生成对应的changes，可直接链到github上看变更详情

# 5 错误备注
- linux 的git版本如果过低，会抛出异常（ERROR: Couldn't find any revision to build. Verify the repository and branch configuration for this job.）
- git 版本安装正确后，在（全局工具配置）里面的git选项，设置`Path to Git excutable`的路径为安装的git路径。该git的路径设置应该在linux上执行`whereis git`命令后获取到的git路径，而不是你文件放置的位置：<br>
![](assets/45.png)<br>

# 6 github 的PR自动构建
## 6.1 安装配置插件
之前的配置，都是向master分支push操作触发jenkins进行构建，但是在一般的正常工作中，不会允许程序员直接向主分支推送代码；正常都是fork一个本地的分支，在本地分支调试完后，向主干分支提交pull request，待相关的管理人员进行review后，才merge到master分支；
基于此，我们之前的配置就有点不合适了，接下来我们就一块研究下如何在别人提交pull request时，就自动触发构建，当然这个构建要执行的任务，应该是将新提交的代码获取到服务器，并部署到环境当中，这应该是一些基本的操作，不懂就问下别人你们的环境如何部署；这里我们主要看如何配置jenkins能使pull request触发构建
- 安装pull request builder plugin插件
- 配置pull request builder plugin插件<br>
![](assets/46.png)<br>
1. GitHub Server API URL：　　如果不是使用的企业版jenkins，就保持默认的https://api.github.com；
1. Jenkins URL overrde：　　如果考虑到防火墙、跨域等问题，可以写一个替换连接jenkins主页的url；
1. Shared secret：　　如果填写一个密码，则每一个提交的pull request都需要验证这个密码才能连接jenkins；
1. Credentials：　　选择我们之前用github生成的token创建的认证身份；一般这个身份在github中具有较高的权限；
- 完后点击下方的测试链接，来测试jenkins与github的基本连接以及身份用户的权限验证.其中Repository ownere/name，顾名思义就是填写github的用户名跟远程库名，中间有反斜杠/；在Description写一个这个Credentials的描述，以区分将来不同Credentials<br>
![](assets/47.png)<br>
- 下面Admin list中填写github用户白名单，在白名单中的用户提交pull request，可以直接触发构建，没有在白名单中的，需要通过admin的确认<br>
![](assets/48.png)<br>
- ok，配置完后点击保存.
## 6.2 配置jenkins任务(这里只说部分不一样的)
-  源码管理，基本配置搞定后，点击高级：
　　Name： origin
　　Refspec：+refs/pull/*:refs/remotes/origin/pr/*
　　Branch Specifier： 填写${sha1}，如果想要用到提交的pr，则这个地方填写${ghprbActualCommit}。

官网描述:
```javascript
Under Advanced, set Name to origin and:
If you just want to build PRs, set refspec to +refs/pull/*:refs/remotes/origin/pr/*
If you want to build PRs and branches, set refspec to +refs/heads/*:refs/remotes/origin/* +refs/pull/*:refs/remotes/origin/pr/* (see note below about parameterized builds)
In Branch Specifier, enter ${sha1} instead of the default */master.
If you want to use the actual commit in the pull request, use ${ghprbActualCommit} instead of ${sha1}
```
![](assets/49.png)<br>

- 构建触发器<br>
如果插件安装正常，构建触发器这边会有GitHub Pull Request Builder，不要选择之前的push触发的那个咯；下面的credentials选择下拉框给出的就好，应该就是之前在系统设置中测试通过的那个；
Admin list填写对于这个job要加入白名单的github用户；下面的Use github hooks for build triggering勾选；<br>
![](assets/50.png)<br>
- github hook中设置Pull request方式<br>
![](assets/52.png)<br>